<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>EL SEGARRO RUNNER - ENHANCED</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      touch-action: none;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #0a0a14;
      font-family: 'Courier New', monospace;
      overflow: hidden;
      color: white;
      width: 100vw;
      height: 100vh;
      position: fixed;
    }

    #game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      background: #0a0a14;
    }

    #hud {
      position: absolute;
      top: 2%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4vw;
      background: rgba(0, 0, 0, 0.85);
      padding: 1.8vh 3.5vw;
      border-radius: 3vh;
      border: 2px solid #ffd166;
      box-shadow: 0 0 15px rgba(255, 209, 102, 0.7), 0 0 30px rgba(255, 209, 102, 0.3);
      font-size: 2.8vh;
      font-weight: bold;
      z-index: 10;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      animation: hudPulse 3s ease-in-out infinite;
    }

    @keyframes hudPulse {
      0%, 100% { box-shadow: 0 0 15px rgba(255, 209, 102, 0.7), 0 0 30px rgba(255, 209, 102, 0.3); }
      50% { box-shadow: 0 0 25px rgba(255, 209, 102, 0.9), 0 0 50px rgba(255, 209, 102, 0.5); }
    }

    #score-display, #record-display {
      position: absolute;
      top: 2%;
      font-size: 3.2vh;
      font-weight: bold;
      color: #ffd166;
      text-shadow: 0 0 8px rgba(255, 209, 102, 0.9), 0 0 15px rgba(255, 77, 77, 0.5);
      font-family: 'Courier New', monospace;
      z-index: 10;
      text-align: center;
      width: 30%;
      transition: transform 0.1s ease-out, text-shadow 0.2s;
    }

    #score-display { right: 3%; }
    #record-display { left: 3%; }

    #score-display.bump {
      transform: scale(1.3);
      text-shadow: 0 0 15px rgba(255, 209, 102, 1), 0 0 30px rgba(255, 77, 77, 0.8);
    }

    #game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: rgba(0, 0, 0, 0.95);
      color: #ff4d4d;
      padding: 4vh 6vw;
      border-radius: 4vh;
      border: 4px solid #ff4d4d;
      text-align: center;
      z-index: 20;
      box-shadow: 
        0 0 30px rgba(255, 77, 77, 0.9),
        0 0 50px rgba(255, 209, 102, 0.5),
        inset 0 0 50px rgba(255, 77, 77, 0.1);
      width: 85%;
      max-width: 75vw;
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #game-over.show {
      transform: translate(-50%, -50%) scale(1);
    }

    #game-over h2 {
      font-size: 5vh;
      margin-bottom: 4vh;
      text-shadow: 0 0 15px rgba(255, 77, 77, 0.95);
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
      background: linear-gradient(45deg, #ff4d4d, #ffd166, #ff4d4d);
      background-size: 200% 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 2s ease infinite;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    #game-over p {
      font-size: 3.5vh;
      margin-bottom: 6vh;
      color: #ffd166;
      font-family: 'Courier New', monospace;
      text-shadow: 0 0 10px rgba(255, 209, 102, 0.8);
    }

    #restart-btn {
      background: linear-gradient(45deg, #06d6a0, #118ab2, #06d6a0);
      background-size: 200% 200%;
      color: white;
      border: none;
      padding: 3vh 10vw;
      font-size: 4.5vh;
      border-radius: 3vh;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      font-family: 'Courier New', monospace;
      box-shadow: 0 4px 20px rgba(6, 214, 160, 0.6);
      width: 90%;
      margin: 0 auto;
      display: block;
      animation: gradientShift 3s ease infinite;
    }

    #restart-btn:hover {
      transform: scale(1.07);
      box-shadow: 0 6px 35px rgba(6, 214, 160, 0.9);
    }

    #restart-btn:active {
      transform: scale(0.98);
    }

    #instructions {
      position: absolute;
      bottom: 3%;
      left: 50%;
      transform: translateX(-50%);
      color: #a8dadc;
      font-size: 2.4vh;
      text-align: center;
      width: 95%;
      font-family: 'Courier New', monospace;
      background: rgba(0, 0, 0, 0.7);
      padding: 1.5vh 3vw;
      border-radius: 2.5vh;
      z-index: 10;
      text-shadow: 0 0 5px rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(168, 218, 220, 0.3);
    }

    #title-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0f0c29, #1a1a2e, #0f0c29);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30;
      gap: 6vh;
      touch-action: auto;
      overflow: hidden;
    }

    #title-screen::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 209, 102, 0.1) 0%, transparent 50%);
      animation: bgPulse 4s ease-in-out infinite;
    }

    @keyframes bgPulse {
      0%, 100% { transform: translate(-25%, -25%) scale(1); opacity: 0.5; }
      50% { transform: translate(-25%, -25%) scale(1.2); opacity: 1; }
    }

    #title-screen h1 {
      font-size: 9vh;
      font-weight: bold;
      color: #ffd166;
      text-shadow: 
        0 0 15px rgba(255, 209, 102, 0.9),
        0 0 30px rgba(255, 77, 77, 0.7),
        0 0 45px rgba(255, 209, 102, 0.5);
      font-family: 'Courier New', monospace;
      letter-spacing: 3px;
      animation: pulseTitle 2s infinite;
      text-align: center;
      padding: 0 5vw;
      background: linear-gradient(45deg, #ffd166, #ff4d4d, #ffd166, #ff4d4d);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: pulseTitle 2s infinite, gradientTitle 4s ease infinite;
      z-index: 1;
    }

    @keyframes pulseTitle {
      0%, 100% { transform: scale(1); filter: drop-shadow(0 0 15px rgba(255, 209, 102, 0.9)); }
      50% { transform: scale(1.07); filter: drop-shadow(0 0 30px rgba(255, 77, 77, 0.9)); }
    }

    @keyframes gradientTitle {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    #start-btn {
      background: linear-gradient(45deg, #ff4d4d, #ffd166, #ff4d4d);
      background-size: 200% 200%;
      color: white;
      border: none;
      padding: 4vh 12vw;
      font-size: 6vh;
      border-radius: 4vh;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
      font-family: 'Courier New', monospace;
      box-shadow: 
        0 0 25px rgba(255, 77, 77, 0.8),
        0 0 50px rgba(255, 209, 102, 0.6);
      letter-spacing: 2px;
      animation: gradientShift 3s ease infinite;
      z-index: 1;
      position: relative;
      overflow: hidden;
    }

    #start-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transform: rotate(45deg);
      animation: btnShine 3s ease-in-out infinite;
    }

    @keyframes btnShine {
      0% { transform: translateX(-100%) rotate(45deg); }
      50%, 100% { transform: translateX(100%) rotate(45deg); }
    }

    #start-btn:hover {
      transform: scale(1.1);
      box-shadow: 
        0 0 35px rgba(255, 77, 77, 0.95),
        0 0 70px rgba(255, 209, 102, 0.8);
    }

    #start-btn:active {
      transform: scale(0.98);
    }

    #carril-indicator {
      position: absolute;
      bottom: 22%;
      left: 50%;
      transform: translateX(-50%);
      width: 5vw;
      height: 1.2vh;
      background: linear-gradient(90deg, #4cc9f0, #4361ee, #3a0ca3);
      border-radius: 1vh;
      box-shadow: 0 0 15px rgba(76, 201, 240, 0.9), 0 0 30px rgba(67, 97, 238, 0.5);
      transition: left 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94), width 0.2s, box-shadow 0.2s;
      z-index: 5;
    }

    #carril-indicator.active {
      width: 7vw;
      box-shadow: 0 0 25px rgba(76, 201, 240, 1), 0 0 50px rgba(67, 97, 238, 0.8);
    }

    #audio-message {
      position: absolute;
      bottom: 12%;
      left: 50%;
      transform: translateX(-50%) scale(0);
      background: linear-gradient(90deg, #ffd166, #ff9e6d, #ffd166);
      background-size: 200% 200%;
      color: #0a0a14;
      padding: 2vh 5vw;
      border-radius: 3vh;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 3vh;
      z-index: 15;
      box-shadow: 0 0 20px rgba(255, 209, 102, 0.9);
      animation: gradientShift 2s ease infinite;
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #audio-message.show {
      transform: translateX(-50%) scale(1);
    }

    /* Screen shake */
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    .shake {
      animation: shake 0.4s ease-in-out;
    }

    /* Combo indicator */
    #combo-display {
      position: absolute;
      top: 15%;
      right: 5%;
      font-size: 4vh;
      font-weight: bold;
      color: #ff4d4d;
      text-shadow: 0 0 15px rgba(255, 77, 77, 0.9);
      font-family: 'Courier New', monospace;
      z-index: 10;
      opacity: 0;
      transform: scale(0);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    #combo-display.show {
      opacity: 1;
      transform: scale(1);
    }

    /* Speed indicator */
    #speed-indicator {
      position: absolute;
      bottom: 15%;
      left: 3%;
      width: 8vw;
      height: 1vh;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 1vh;
      overflow: hidden;
      z-index: 10;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #speed-bar {
      height: 100%;
      background: linear-gradient(90deg, #06d6a0, #ffd166, #ff4d4d);
      border-radius: 1vh;
      transition: width 0.5s ease-out;
      box-shadow: 0 0 10px currentColor;
    }
  </style>
</head>
<body>
  <div id="game-container">
    <div id="hud">
      <div>
        <span>‚ù§Ô∏è</span> <span id="vidas-count">1</span>
      </div>
      <div>
        <span>üö¨</span> <span id="cigarros-count">0</span>/5
      </div>
    </div>
    <div id="score-display">SCORE: 0</div>
    <div id="record-display">R√âCORD: 0</div>
    <div id="combo-display">x0</div>
    <div id="speed-indicator"><div id="speed-bar" style="width: 20%"></div></div>
    <canvas id="game-canvas"></canvas>
    
    <div id="carril-indicator"></div>
    
    <div id="game-over">
      <h2>¬°RECISTA!</h2>
      <p id="final-score">SCORE: 0</p>
      <p id="best-record">MEJOR R√âCORD: 0</p>
      <button id="restart-btn">OTRA VEZ, AMIGOO</button>
    </div>
    
    <div id="instructions">
      <p>‚Üê ‚Üí : Carriles | ‚Üë : Saltar | ‚Üì : Agacharse | 3‚Üì r√°pidos: EURO</p>
    </div>

    <div id="title-screen">
      <h1>EL SEGARRO RUNNER</h1>
      <button id="start-btn">EMPEZAR A FUMAR</button>
    </div>

    <div id="audio-message">üîä ¬°MUSIQUILLA √ÅRABE ACTIVADA!</div>
  </div>

  <script>
    // ==================== CONFIGURACI√ìN DE ALTA RESOLUCI√ìN ====================
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    
    const dpr = window.devicePixelRatio || 1;
    
    function resizeCanvas() {
      canvas.width = canvas.clientWidth * dpr;
      canvas.height = canvas.clientHeight * dpr;
      ctx.scale(dpr, dpr);
    }
    
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function virtualX(x) { return (x / 800) * canvas.clientWidth; }
    function virtualY(y) { return (y / 600) * canvas.clientHeight; }
    function virtualW(w) { return (w / 800) * canvas.clientWidth; }
    function virtualH(h) { return (h / 600) * canvas.clientHeight; }

    // ==================== ELEMENTOS DEL DOM ====================
    const scoreDisplay = document.getElementById('score-display');
    const recordDisplay = document.getElementById('record-display');
    const vidasDisplay = document.getElementById('vidas-count');
    const cigarrosDisplay = document.getElementById('cigarros-count');
    const gameOverPanel = document.getElementById('game-over');
    const finalScoreDisplay = document.getElementById('final-score');
    const bestRecordDisplay = document.getElementById('best-record');
    const restartBtn = document.getElementById('restart-btn');
    const titleScreen = document.getElementById('title-screen');
    const startBtn = document.getElementById('start-btn');
    const audioMessage = document.getElementById('audio-message');
    const carrilIndicator = document.getElementById('carril-indicator');
    const instructions = document.getElementById('instructions');
    const gameContainer = document.getElementById('game-container');
    const comboDisplay = document.getElementById('combo-display');
    const speedBar = document.getElementById('speed-bar');

    const esMovil = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                    ('ontouchstart' in window || navigator.maxTouchPoints > 0);

    // ==================== CONSTANTES DEL JUEGO ====================
    const CARRILES = { IZQUIERDA: 0, CENTRO: 1, DERECHA: 2 };
    const POS_X_CARRIL_VIRTUAL = [200, 400, 600];
    const POS_Y_BASE_VIRTUAL = 350;
    const umbralSwipe = 20;
    const umbralSwipeEURO = 40;
    const tiempoMaximoSwipe = 400;

    // ==================== SISTEMA DE PART√çCULAS MEJORADO ====================
    class Particula {
      constructor(x, y, opciones = {}) {
        this.x = x;
        this.y = y;
        this.vx = opciones.vx || (Math.random() - 0.5) * 4;
        this.vy = opciones.vy || (Math.random() - 0.5) * 4 - 2;
        this.radio = opciones.radio || 3 + Math.random() * 5;
        this.radioInicial = this.radio;
        this.color = opciones.color || '#ffd166';
        this.vida = opciones.vida || 60;
        this.vidaMax = this.vida;
        this.gravedad = opciones.gravedad || 0.1;
        this.friccion = opciones.friccion || 0.98;
        this.tipo = opciones.tipo || 'circulo';
        this.rotacion = Math.random() * Math.PI * 2;
        this.rotacionVel = (Math.random() - 0.5) * 0.2;
      }
      
      actualizar() {
        this.vy += this.gravedad;
        this.vx *= this.friccion;
        this.vy *= this.friccion;
        this.x += this.vx;
        this.y += this.vy;
        this.vida--;
        this.radio = this.radioInicial * (this.vida / this.vidaMax);
        this.rotacion += this.rotacionVel;
      }
      
      dibujar(ctx) {
        const alpha = this.vida / this.vidaMax;
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.rotacion);
        
        if (this.tipo === 'estrella') {
          this.dibujarEstrella(ctx);
        } else if (this.tipo === 'humo') {
          this.dibujarHumo(ctx);
        } else {
          ctx.fillStyle = this.color;
          ctx.shadowColor = this.color;
          ctx.shadowBlur = 10;
          ctx.beginPath();
          ctx.arc(0, 0, this.radio, 0, Math.PI * 2);
          ctx.fill();
        }
        
        ctx.restore();
      }
      
      dibujarEstrella(ctx) {
        ctx.fillStyle = this.color;
        ctx.shadowColor = this.color;
        ctx.shadowBlur = 15;
        ctx.beginPath();
        for (let i = 0; i < 5; i++) {
          const angle = (i * 4 * Math.PI) / 5 - Math.PI / 2;
          const x = Math.cos(angle) * this.radio;
          const y = Math.sin(angle) * this.radio;
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.closePath();
        ctx.fill();
      }
      
      dibujarHumo(ctx) {
        const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.radio);
        gradient.addColorStop(0, `rgba(200, 200, 200, 0.8)`);
        gradient.addColorStop(1, `rgba(150, 150, 150, 0)`);
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(0, 0, this.radio, 0, Math.PI * 2);
        ctx.fill();
      }
      
      estaMuerta() { return this.vida <= 0 || this.radio < 0.5; }
    }

    // Sistema de part√≠culas global
    const particulas = [];

    function crearExplosion(x, y, color, cantidad = 15) {
      for (let i = 0; i < cantidad; i++) {
        particulas.push(new Particula(x, y, {
          color: color,
          vx: (Math.random() - 0.5) * 8,
          vy: (Math.random() - 0.5) * 8 - 3,
          radio: 2 + Math.random() * 6,
          vida: 40 + Math.random() * 30,
          tipo: Math.random() > 0.5 ? 'estrella' : 'circulo'
        }));
      }
    }

    function crearTrail(x, y, color) {
      particulas.push(new Particula(x, y, {
        color: color,
        vx: (Math.random() - 0.5) * 1,
        vy: 0.5,
        radio: 2 + Math.random() * 3,
        vida: 20,
        gravedad: 0,
        tipo: 'circulo'
      }));
    }

    function crearHumo(x, y) {
      particulas.push(new Particula(x, y, {
        vx: (Math.random() - 0.5) * 0.5,
        vy: -1 - Math.random() * 0.5,
        radio: 4 + Math.random() * 6,
        vida: 50 + Math.random() * 30,
        gravedad: -0.02,
        friccion: 0.99,
        tipo: 'humo'
      }));
    }

    // ==================== CLASE TEXTO EMERGENTE MEJORADA ====================
    class TextoEmergente {
      constructor(texto, x, y, color = '#ffd166', opciones = {}) {
        this.texto = texto;
        this.x = x;
        this.y = y;
        this.color = color;
        this.vida = opciones.gigante ? 100 : 70;
        this.vidaMax = this.vida;
        this.velocidadY = -2;
        this.escala = opciones.gigante ? 2.2 : 1.2;
        this.escalaBase = this.escala;
        this.vibrar = opciones.vibrar || false;
        this.tiempo = 0;
        this.rebote = opciones.rebote || false;
      }
      
      actualizar() {
        this.y += this.velocidadY;
        this.vida--;
        this.tiempo++;
        
        if (this.rebote && this.tiempo < 15) {
          this.escala = this.escalaBase * (1 + Math.sin(this.tiempo * 0.5) * 0.3);
        }
      }
      
      dibujar(ctx) {
        ctx.save();
        const alpha = Math.min(1, this.vida / (this.vidaMax * 0.3));
        ctx.globalAlpha = alpha;

        let offsetX = this.x;
        if (this.vibrar) {
          offsetX += Math.sin(this.tiempo * 0.5) * 3;
        }
        
        ctx.font = `bold ${Math.floor(28 * this.escala)}px 'Courier New', monospace`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        // Sombra/glow
        ctx.shadowColor = this.color;
        ctx.shadowBlur = 20;
        
        // Borde
        ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.lineWidth = 5 * this.escala;
        ctx.lineJoin = 'round';
        ctx.strokeText(this.texto, offsetX, this.y);
        
        // Texto con gradiente
        const gradient = ctx.createLinearGradient(offsetX - 50, this.y - 20, offsetX + 50, this.y + 20);
        gradient.addColorStop(0, this.color);
        gradient.addColorStop(0.5, '#ffffff');
        gradient.addColorStop(1, this.color);
        ctx.fillStyle = gradient;
        ctx.fillText(this.texto, offsetX, this.y);
        
        ctx.restore();
      }
      
      estaMuerto() { return this.vida <= 0; }
    }

    const textosEmergentes = [];

    // ==================== SCREEN SHAKE ====================
    let shakeIntensity = 0;
    let shakeDecay = 0.9;

    function screenShake(intensity) {
      shakeIntensity = Math.max(shakeIntensity, intensity);
    }

    function aplicarShake() {
      if (shakeIntensity > 0.5) {
        const offsetX = (Math.random() - 0.5) * shakeIntensity * 2;
        const offsetY = (Math.random() - 0.5) * shakeIntensity * 2;
        ctx.translate(offsetX, offsetY);
        shakeIntensity *= shakeDecay;
      } else {
        shakeIntensity = 0;
      }
    }

    // ==================== AUDIO ====================
    let audioContext;
    let audioHabilitado = false;
    let musicaPlaying = false;

    function initAudio() {
      if (audioHabilitado) return;
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        startMusicaArabe();
        audioHabilitado = true;
        audioMessage.classList.add('show');
        setTimeout(() => audioMessage.classList.remove('show'), 3000);
      } catch (e) {
        console.log('Audio no disponible:', e);
      }
    }

    function startMusicaArabe() {
      if (!audioContext || musicaPlaying) return;
      musicaPlaying = true;
      const notas = [110, 130.81, 146.83, 164.81, 196.00];
      let indice = 0;
      
      function tocar() {
        if (!musicaPlaying || !audioContext) return;
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.type = 'sine';
        osc.frequency.value = notas[indice];
        gain.gain.value = 0.06;
        osc.start();
        osc.stop(audioContext.currentTime + 2.0);
        gain.gain.setValueAtTime(0, audioContext.currentTime);
        gain.gain.linearRampToValueAtTime(0.06, audioContext.currentTime + 0.1);
        gain.gain.linearRampToValueAtTime(0, audioContext.currentTime + 1.9);
        indice = (indice + 1) % notas.length;
        setTimeout(tocar, 2400);
      }
      tocar();
    }

    function stopMusicaArabe() { musicaPlaying = false; }

    function crearSonido(frecuencia, tipo, duracion, volumen = 0.3) {
      return () => {
        if (!audioContext) return;
        try {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.type = tipo || 'sine';
          osc.frequency.value = frecuencia;
          gain.gain.value = volumen;
          osc.start();
          osc.stop(audioContext.currentTime + (duracion || 0.2));
          if (duracion) {
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duracion);
          }
        } catch (e) {}
      };
    }

    const sonidoSuspiro = crearSonido(300, 'sine', 0.4, 0.15);
    const sonidoChoque = crearSonido(120, 'square', 0.15, 0.4);
    const sonidoSalto = crearSonido(450, 'sine', 0.12, 0.25);
    const sonidoTos = () => {
      if (!audioContext) return;
      crearSonido(200, 'square', 0.3, 0.6)();
      setTimeout(() => crearSonido(100, 'sawtooth', 0.5, 0.3)(), 100);
    };
    const sonidoEuro = () => {
      if (!audioContext) return;
      crearSonido(800, 'sine', 0.1, 0.3)();
      setTimeout(() => crearSonido(600, 'sine', 0.1, 0.25)(), 100);
    };
    const sonidoCerdo = crearSonido(180, 'sawtooth', 0.3, 0.4);

    // ==================== GESTOS M√ìVIL ====================
    let touchStartX = 0, touchStartY = 0, touchEndX = 0, touchEndY = 0;
    let touchStartTime = 0;
    let contadorSwipesAbajo = 0;
    let tiempoPrimerSwipeAbajo = 0;
    let timeoutResetEURO = null;
    
    function resetContadorEURO() {
      contadorSwipesAbajo = 0;
      tiempoPrimerSwipeAbajo = 0;
      if (timeoutResetEURO) {
        clearTimeout(timeoutResetEURO);
        timeoutResetEURO = null;
      }
    }

    canvas.addEventListener('touchstart', (e) => {
      if (juego.estado !== 'jugando') return;
      touchStartTime = Date.now();
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      e.preventDefault();
    }, { passive: false });

    canvas.addEventListener('touchend', (e) => {
      if (juego.estado !== 'jugando') return;
      const ahora = Date.now();
      const duracionSwipe = ahora - touchStartTime;
      touchEndX = e.changedTouches[0].clientX;
      touchEndY = e.changedTouches[0].clientY;
      if (duracionSwipe <= tiempoMaximoSwipe) {
        detectarSwipe();
      }
      e.preventDefault();
    }, { passive: false });

    canvas.addEventListener('touchmove', (e) => {
      if (juego.estado === 'jugando') e.preventDefault();
    }, { passive: false });

    function detectarSwipe() {
      const diffX = touchEndX - touchStartX;
      const diffY = touchEndY - touchStartY;
      
      if (Math.abs(diffX) > Math.abs(diffY)) {
        resetContadorEURO();
        if (diffX > umbralSwipe && jugador.carril < 2) {
          jugador.carril++;
          jugador.carrilCambiado = true;
        } else if (diffX < -umbralSwipe && jugador.carril > 0) {
          jugador.carril--;
          jugador.carrilCambiado = true;
        }
        return;
      }
      
      if (diffY > umbralSwipe && diffY < umbralSwipeEURO && jugador.enSuelo && !jugador.agachado) {
        resetContadorEURO();
        jugador.agachado = true;
        jugador.altoVirtual = 40;
        return;
      }
      
      if (diffY < -umbralSwipe && jugador.enSuelo) {
        resetContadorEURO();
        jugador.vy = -15;
        jugador.enSuelo = false;
        jugador.saltando = true;
        sonidoSalto();
        return;
      }
      
      if (diffY >= umbralSwipeEURO) {
        const ahora = Date.now();
        if (contadorSwipesAbajo === 0) {
          tiempoPrimerSwipeAbajo = ahora;
          contadorSwipesAbajo = 1;
        } else if (ahora - tiempoPrimerSwipeAbajo < 1000) {
          contadorSwipesAbajo++;
          if (contadorSwipesAbajo >= 3 && !jugador.trucoEuro.usado) {
            activarTrucoEuro();
            resetContadorEURO();
            return;
          }
        } else {
          resetContadorEURO();
          contadorSwipesAbajo = 1;
          tiempoPrimerSwipeAbajo = ahora;
        }
        if (timeoutResetEURO) clearTimeout(timeoutResetEURO);
        timeoutResetEURO = setTimeout(resetContadorEURO, 1000);
      }
    }

    // ==================== CONTROLES TECLADO ====================
    document.addEventListener('keydown', (e) => {
      if (juego.estado !== 'jugando') return;
      
      switch(e.key) {
        case 'ArrowLeft':
          if (jugador.carril > 0) {
            jugador.carril--;
            jugador.carrilCambiado = true;
          }
          break;
        case 'ArrowRight':
          if (jugador.carril < 2) {
            jugador.carril++;
            jugador.carrilCambiado = true;
          }
          break;
        case 'ArrowUp':
          if (jugador.enSuelo) {
            jugador.vy = -15;
            jugador.enSuelo = false;
            jugador.saltando = true;
            sonidoSalto();
          }
          break;
        case 'ArrowDown':
          if (jugador.enSuelo && !jugador.agachado) {
            jugador.agachado = true;
            jugador.altoVirtual = 40;
          }
          break;
      }
    });

    document.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowDown') {
        jugador.agachado = false;
        jugador.altoVirtual = 65;
      }
    });

    // ==================== ESTADO DEL JUEGO ====================
    const juego = {
      estado: 'menu',
      score: 0,
      velocidadBase: 4.8,
      velocidad: 4.8,
      tiempo: 0,
      frecuenciaObstaculos: 90,
      contadorObstaculos: 0,
      pantallaRoja: 0,
      record: localStorage.getItem('segarroRecord') ? parseInt(localStorage.getItem('segarroRecord')) : 0,
      choquesSinMorir: 0,
      totalCigarrosReales: 0,
      combo: 0,
      ultimoScoreBump: 0
    };

    recordDisplay.textContent = `R√âCORD: ${juego.record}`;

    // ==================== JUGADOR ====================
    const jugador = {
      carril: CARRILES.CENTRO,
      yVirtual: POS_Y_BASE_VIRTUAL,
      vy: 0,
      anchoVirtual: 35,
      altoVirtual: 65,
      colorPiel: '#6d4c41',
      colorRopa: '#2e7d32',
      colorZapatos: '#212121',
      saltando: false,
      agachado: false,
      enSuelo: true,
      gravedad: 0.6,
      vidas: 1,
      cigarros: 0,
      invulnerable: false,
      tiempoInvulnerable: 0,
      trucoEuro: { usado: false },
      pakiRicoh: {
        activo: false,
        contador: 0,
        duracion: 420,
        cambiosRestantes: 0,
        proximoCambio: 60,
        direccion: 0
      },
      enEscenaFinal: false,
      amigos: [],
      carrilCambiado: false
    };

    // ==================== OBST√ÅCULOS ====================
    const obstaculos = [];
    const cigarros = [];
    const cerdos = [];

    // ==================== FUNCIONES DEL JUEGO ====================
    function activarTrucoEuro() {
      if (jugador.trucoEuro.usado || jugador.pakiRicoh.activo || jugador.enEscenaFinal) return;
      
      jugador.trucoEuro.usado = true;
      juego.estado = 'pausado_truco';
      jugador.vidas++;
      vidasDisplay.textContent = jugador.vidas;
      
      textosEmergentes.push(new TextoEmergente(
        "‚Ç¨URO", 
        virtualX(400), virtualY(300),
        '#ffd700', { gigante: true, vibrar: true, rebote: true }
      ));
      
      // Explosi√≥n de part√≠culas doradas
      crearExplosion(virtualX(400), virtualY(300), '#ffd700', 30);
      screenShake(10);
      sonidoEuro();
      
      setTimeout(() => {
        if (juego.estado === 'pausado_truco') juego.estado = 'jugando';
      }, 2000);
    }

    function generarObstaculo() {
      if (juego.contadorObstaculos >= juego.frecuenciaObstaculos) {
        const random = Math.random();
        
        if (random < 0.45) {
          const carril = Math.floor(Math.random() * 3);
          obstaculos.push({
            xVirtual: POS_X_CARRIL_VIRTUAL[carril] - 28,
            yVirtual: -90,
            anchoVirtual: 56,
            altoVirtual: 75,
            carril: carril,
            tipo: 'policia',
            velocidadExtra: 0,
            colorUniforme: '#2196f3',
            colorGorra: '#1565c0'
          });
        } else if (random < 0.67) {
          const carril = Math.floor(Math.random() * 3);
          obstaculos.push({
            xVirtual: POS_X_CARRIL_VIRTUAL[carril] - 28,
            yVirtual: -90,
            anchoVirtual: 56,
            altoVirtual: 75,
            carril: carril,
            tipo: 'policia',
            velocidadExtra: 1,
            colorUniforme: '#1565c0',
            colorGorra: '#0a3a75'
          });
        } else if (random < 0.75) {
          const carril = Math.floor(Math.random() * 3);
          cerdos.push({
            xVirtual: POS_X_CARRIL_VIRTUAL[carril] - 30,
            yVirtual: -70,
            anchoVirtual: 60,
            altoVirtual: 50,
            carril: carril,
            tipo: 'cerdo'
          });
        } else {
          const carril = Math.floor(Math.random() * 3);
          cigarros.push({
            xVirtual: POS_X_CARRIL_VIRTUAL[carril] - 22,
            yVirtual: -65,
            anchoVirtual: 44,
            altoVirtual: 30,
            carril: carril,
            tipo: 'cigarro',
            tiempoBrasa: 0,
            flotacion: Math.random() * Math.PI * 2
          });
        }
        
        juego.contadorObstaculos = 0;
      } else {
        juego.contadorObstaculos++;
      }
    }

    function moverObstaculos() {
      for (let i = obstaculos.length - 1; i >= 0; i--) {
        obstaculos[i].yVirtual += juego.velocidad + obstaculos[i].velocidadExtra;
        if (obstaculos[i].yVirtual > 700) obstaculos.splice(i, 1);
      }
      
      for (let i = cerdos.length - 1; i >= 0; i--) {
        cerdos[i].yVirtual += 1.5;
        if (cerdos[i].yVirtual > 700) cerdos.splice(i, 1);
      }
      
      for (let i = cigarros.length - 1; i >= 0; i--) {
        cigarros[i].yVirtual += juego.velocidad;
        cigarros[i].tiempoBrasa = (cigarros[i].tiempoBrasa + 1) % 20;
        cigarros[i].flotacion += 0.1;
        if (cigarros[i].yVirtual > 700) cigarros.splice(i, 1);
      }
    }

    function detectarColisiones() {
      const jugadorXVirtual = POS_X_CARRIL_VIRTUAL[jugador.carril] - jugador.anchoVirtual / 2;
      const jugadorYVirtual = jugador.yVirtual - jugador.altoVirtual / 2;
      
      // Polic√≠as
      for (let i = obstaculos.length - 1; i >= 0; i--) {
        const obs = obstaculos[i];
        const obsXVirtual = obs.xVirtual;
        const obsYVirtual = obs.yVirtual - obs.altoVirtual / 2;
        
        if (jugador.pakiRicoh.activo) {
          if (colision(jugadorXVirtual, jugadorYVirtual, jugador.anchoVirtual, jugador.altoVirtual, 
                      obsXVirtual, obsYVirtual, obs.anchoVirtual, obs.altoVirtual)) {
            if (Math.random() < 0.3) {
              textosEmergentes.push(new TextoEmergente(
                "RECISTA", 
                virtualX(POS_X_CARRIL_VIRTUAL[obs.carril]), virtualY(obs.yVirtual - 60),
                '#ff4d4d'
              ));
            }
          }
          continue;
        }
        
        if (colision(jugadorXVirtual, jugadorYVirtual, jugador.anchoVirtual, jugador.altoVirtual, 
                    obsXVirtual, obsYVirtual, obs.anchoVirtual, obs.altoVirtual)) {
          if (!jugador.invulnerable) {
            sonidoChoque();
            juego.choquesSinMorir++;
            juego.combo = 0;
            actualizarCombo();
            
            if (juego.choquesSinMorir >= 3) {
              textosEmergentes.push(new TextoEmergente(
                "MI CARTERA¬°", 
                virtualX(POS_X_CARRIL_VIRTUAL[obs.carril]), virtualY(obs.yVirtual - 70),
                '#ffd166', { gigante: true, vibrar: true }
              ));
              juego.choquesSinMorir = 0;
            }
            
            textosEmergentes.push(new TextoEmergente(
              "RECISTA", 
              virtualX(POS_X_CARRIL_VIRTUAL[obs.carril]), virtualY(obs.yVirtual - 60),
              '#ff4d4d'
            ));
            
            // Efectos visuales de da√±o
            crearExplosion(virtualX(POS_X_CARRIL_VIRTUAL[jugador.carril]), virtualY(jugador.yVirtual), '#ff4d4d', 20);
            screenShake(15);
            juego.pantallaRoja = 30;
            
            if (jugador.vidas > 1) {
              jugador.vidas--;
              vidasDisplay.textContent = jugador.vidas;
              jugador.invulnerable = true;
              jugador.tiempoInvulnerable = 90;
            } else {
              gameOver();
            }
          }
          obstaculos.splice(i, 1);
        }
      }
      
      // Cerdos
      for (let i = cerdos.length - 1; i >= 0; i--) {
        const cerdo = cerdos[i];
        const cerdoXVirtual = cerdo.xVirtual;
        const cerdoYVirtual = cerdo.yVirtual - cerdo.altoVirtual / 2;
        
        if (colision(jugadorXVirtual, jugadorYVirtual, jugador.anchoVirtual, jugador.altoVirtual, 
                    cerdoXVirtual, cerdoYVirtual, cerdo.anchoVirtual, cerdo.altoVirtual)) {
          if (!jugador.invulnerable) {
            sonidoCerdo();
            jugador.vidas--;
            vidasDisplay.textContent = jugador.vidas;
            juego.combo = 0;
            actualizarCombo();
            
            textosEmergentes.push(new TextoEmergente(
              "YALLAH", 
              virtualX(POS_X_CARRIL_VIRTUAL[cerdo.carril]), virtualY(cerdo.yVirtual - 65),
              '#ff4d4d', { gigante: true, vibrar: true }
            ));
            
            crearExplosion(virtualX(POS_X_CARRIL_VIRTUAL[cerdo.carril]), virtualY(cerdo.yVirtual), '#ff80ab', 25);
            screenShake(20);
            juego.pantallaRoja = 35;
            
            if (jugador.vidas <= 0) {
              gameOver();
            } else {
              jugador.invulnerable = true;
              jugador.tiempoInvulnerable = 90;
            }
          }
          cerdos.splice(i, 1);
        }
      }
      
      // Cigarros
      for (let i = cigarros.length - 1; i >= 0; i--) {
        const cig = cigarros[i];
        const cigXVirtual = cig.xVirtual;
        const cigYVirtual = cig.yVirtual - cig.altoVirtual / 2;
        
        if (colision(jugadorXVirtual, jugadorYVirtual, jugador.anchoVirtual, jugador.altoVirtual, 
                    cigXVirtual, cigYVirtual, cig.anchoVirtual, cig.altoVirtual)) {
          sonidoSuspiro();
          juego.combo++;
          actualizarCombo();
          
          textosEmergentes.push(new TextoEmergente(
            juego.combo > 1 ? `SEGARRO x${juego.combo}` : "SEGARRO", 
            virtualX(POS_X_CARRIL_VIRTUAL[cig.carril]), virtualY(cig.yVirtual - 55),
            '#ffd166', { rebote: true }
          ));
          
          // Part√≠culas doradas al recoger
          crearExplosion(virtualX(POS_X_CARRIL_VIRTUAL[cig.carril]), virtualY(cig.yVirtual), '#ffd166', 12);
          
          jugador.cigarros++;
          juego.totalCigarrosReales++;
          cigarrosDisplay.textContent = jugador.cigarros;
          
          if (jugador.cigarros >= 5) {
            jugador.vidas++;
            jugador.cigarros = 0;
            cigarrosDisplay.textContent = jugador.cigarros;
            vidasDisplay.textContent = jugador.vidas;
            
            textosEmergentes.push(new TextoEmergente(
              "AMIGOO", 
              virtualX(POS_X_CARRIL_VIRTUAL[jugador.carril]), virtualY(jugador.yVirtual - 60),
              '#ffd700', { gigante: true, vibrar: true, rebote: true }
            ));
            
            crearExplosion(virtualX(POS_X_CARRIL_VIRTUAL[jugador.carril]), virtualY(jugador.yVirtual), '#ffd700', 30);
            screenShake(8);
          }
          
          if (juego.totalCigarrosReales % 10 === 0 && juego.totalCigarrosReales > 0) {
            activarPakiRicoh();
          }
          
          cigarros.splice(i, 1);
        }
      }
    }

    function colision(x1, y1, w1, h1, x2, y2, w2, h2) {
      return x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2;
    }

    function actualizarCombo() {
      if (juego.combo > 1) {
        comboDisplay.textContent = `x${juego.combo}`;
        comboDisplay.classList.add('show');
      } else {
        comboDisplay.classList.remove('show');
      }
    }

    function activarPakiRicoh() {
      jugador.pakiRicoh.activo = true;
      jugador.pakiRicoh.contador = 0;
      jugador.pakiRicoh.duracion = 420;
      
      textosEmergentes.push(new TextoEmergente(
        "¬°PAKI RICOH!", 
        virtualX(400), virtualY(300),
        '#ffd700', { gigante: true, vibrar: true, rebote: true }
      ));
      
      crearExplosion(virtualX(400), virtualY(300), '#ffd700', 40);
      screenShake(12);
      
      if (audioContext) {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.type = 'sine';
        osc.frequency.value = 600;
        gain.gain.value = 0.35;
        osc.start();
        osc.stop(audioContext.currentTime + 0.4);
      }
    }

    function actualizarPakiRicoh() {
      if (!jugador.pakiRicoh.activo) return;
      
      jugador.pakiRicoh.contador++;
      
      // Humo constante
      if (Math.random() < 0.4) {
        crearHumo(
          virtualX(POS_X_CARRIL_VIRTUAL[jugador.carril] + (Math.random() - 0.5) * 25),
          virtualY(jugador.yVirtual - 25)
        );
      }
      
      if (jugador.pakiRicoh.contador >= jugador.pakiRicoh.duracion) {
        terminarPakiRicoh();
      }
    }

    function terminarPakiRicoh() {
      jugador.pakiRicoh.activo = false;
      
      textosEmergentes.push(new TextoEmergente(
        "..", 
        virtualX(POS_X_CARRIL_VIRTUAL[jugador.carril]), virtualY(jugador.yVirtual - 50),
        '#ffffff'
      ));
      sonidoTos();
    }

    function actualizarJugador() {
      if (juego.pantallaRoja > 0) juego.pantallaRoja--;
      
      if (!jugador.enSuelo) {
        jugador.vy += jugador.gravedad;
        jugador.yVirtual += jugador.vy;
        if (jugador.yVirtual >= POS_Y_BASE_VIRTUAL) {
          jugador.yVirtual = POS_Y_BASE_VIRTUAL;
          jugador.vy = 0;
          jugador.enSuelo = true;
          jugador.saltando = false;
        }
      }
      
      if (jugador.invulnerable) {
        jugador.tiempoInvulnerable--;
        if (jugador.tiempoInvulnerable <= 0) jugador.invulnerable = false;
      }
      
      if (jugador.agachado && !jugador.enSuelo) {
        jugador.agachado = false;
        jugador.altoVirtual = 65;
      }
      
      // Trail del jugador
      if (juego.tiempo % 3 === 0 && !jugador.enEscenaFinal) {
        crearTrail(
          virtualX(POS_X_CARRIL_VIRTUAL[jugador.carril]),
          virtualY(jugador.yVirtual + 20),
          jugador.pakiRicoh.activo ? '#ffd700' : '#2e7d32'
        );
      }
      
      actualizarPakiRicoh();
    }

    function actualizarDificultad() {
      juego.score++;
      
      // Bump animation para score
      if (juego.score - juego.ultimoScoreBump >= 100) {
        scoreDisplay.classList.add('bump');
        setTimeout(() => scoreDisplay.classList.remove('bump'), 100);
        juego.ultimoScoreBump = juego.score;
      }
      
      scoreDisplay.textContent = `SCORE: ${juego.score}`;
      
      // Actualizar barra de velocidad
      const velocidadNivel = Math.min(100, ((juego.velocidad - 4.8) / 4.2) * 100);
      speedBar.style.width = `${20 + velocidadNivel * 0.8}%`;
      
      juego.velocidad = 4.8;
      if (juego.score >= 1000) juego.velocidad += 0.6;
      if (juego.score >= 2000) juego.velocidad += 0.6;
      if (juego.score >= 3500) juego.velocidad += 0.6;
      if (juego.score >= 5500) juego.velocidad += 0.6;
      if (juego.score >= 8000) juego.velocidad += 0.6;
      if (juego.score >= 11000) juego.velocidad += 0.6;
      if (juego.score >= 15000) juego.velocidad += 0.6;
      
      if (juego.score >= 30000 && juego.estado !== 'final') {
        escenaFinal();
        return;
      }
      
      if (juego.score % 1200 === 0 && juego.frecuenciaObstaculos > 40) {
        juego.frecuenciaObstaculos -= 6;
      }
    }

    function actualizarTextos() {
      for (let i = textosEmergentes.length - 1; i >= 0; i--) {
        textosEmergentes[i].actualizar();
        if (textosEmergentes[i].estaMuerto()) textosEmergentes.splice(i, 1);
      }
    }

    function actualizarParticulas() {
      for (let i = particulas.length - 1; i >= 0; i--) {
        particulas[i].actualizar();
        if (particulas[i].estaMuerta()) particulas.splice(i, 1);
      }
    }

    function escenaFinal() {
      juego.estado = 'final';
      jugador.enEscenaFinal = true;
      stopMusicaArabe();
      
      if (audioContext) {
        const notas = [110, 130.81, 146.83];
        let indice = 0;
        function tocar() {
          if (!audioContext) return;
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.type = 'sine';
          osc.frequency.value = notas[indice];
          gain.gain.value = 0.08;
          osc.start();
          osc.stop(audioContext.currentTime + 1.2);
          gain.gain.setValueAtTime(0.08, audioContext.currentTime);
          gain.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 1.2);
          indice = (indice + 1) % notas.length;
          setTimeout(tocar, 1800);
        }
        tocar();
      }
      
      jugador.amigos = [];
      const posiciones = [
        { x: 300, y: 410, colorPiel: '#795548', colorRopa: '#d32f2f' },
        { x: 360, y: 425, colorPiel: '#5d4037', colorRopa: '#1976d2' },
        { x: 440, y: 425, colorPiel: '#8d6e63', colorRopa: '#388e3c' },
        { x: 500, y: 410, colorPiel: '#6d4c41', colorRopa: '#f57c00' },
        { x: 400, y: 450, colorPiel: '#5d4037', colorRopa: '#7b1fa2' }
      ];
      
      posiciones.forEach(pos => {
        jugador.amigos.push({
          xVirtual: pos.x,
          yVirtual: pos.y,
          colorPiel: pos.colorPiel,
          colorRopa: pos.colorRopa
        });
      });
    }

    function gameOver() {
      juego.estado = 'gameover';
      
      if (juego.score > juego.record) {
        juego.record = juego.score;
        localStorage.setItem('segarroRecord', juego.record.toString());
        recordDisplay.textContent = `R√âCORD: ${juego.record}`;
      }
      
      finalScoreDisplay.textContent = `SCORE: ${juego.score}`;
      bestRecordDisplay.textContent = `MEJOR R√âCORD: ${juego.record}`;
      gameOverPanel.classList.add('show');
      
      screenShake(25);
      crearExplosion(virtualX(400), virtualY(300), '#ff4d4d', 50);
      
      if (audioContext) {
        const osc1 = audioContext.createOscillator();
        const osc2 = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc1.connect(gain);
        osc2.connect(gain);
        gain.connect(audioContext.destination);
        osc1.frequency.value = 650;
        osc2.frequency.value = 850;
        gain.gain.value = 0.2;
        osc1.start();
        osc2.start();
        
        let asc = true;
        const int = setInterval(() => {
          if (!audioContext) { clearInterval(int); return; }
          osc1.frequency.value = asc ? 850 : 650;
          osc2.frequency.value = asc ? 1050 : 850;
          asc = !asc;
        }, 300);
        
        setTimeout(() => {
          clearInterval(int);
          osc1.stop();
          osc2.stop();
        }, 2500);
      }
      
      stopMusicaArabe();
    }

    function reiniciarJuego() {
      juego.estado = 'jugando';
      juego.score = 0;
      juego.velocidad = juego.velocidadBase;
      juego.frecuenciaObstaculos = 90;
      juego.contadorObstaculos = 0;
      juego.pantallaRoja = 0;
      juego.choquesSinMorir = 0;
      juego.combo = 0;
      juego.ultimoScoreBump = 0;
      
      jugador.carril = CARRILES.CENTRO;
      jugador.yVirtual = POS_Y_BASE_VIRTUAL;
      jugador.vy = 0;
      jugador.saltando = false;
      jugador.agachado = false;
      jugador.altoVirtual = 65;
      jugador.enSuelo = true;
      jugador.vidas = 1;
      jugador.cigarros = 0;
      jugador.invulnerable = false;
      jugador.tiempoInvulnerable = 0;
      jugador.trucoEuro = { usado: false };
      jugador.pakiRicoh = { activo: false, contador: 0, duracion: 420, cambiosRestantes: 0, proximoCambio: 60, direccion: 0 };
      jugador.enEscenaFinal = false;
      jugador.amigos = [];
      
      obstaculos.length = 0;
      cigarros.length = 0;
      cerdos.length = 0;
      textosEmergentes.length = 0;
      particulas.length = 0;
      
      resetContadorEURO();
      actualizarCombo();
      
      scoreDisplay.textContent = `SCORE: 0`;
      vidasDisplay.textContent = jugador.vidas;
      cigarrosDisplay.textContent = jugador.cigarros;
      speedBar.style.width = '20%';
      
      gameOverPanel.classList.remove('show');
      
      if (audioHabilitado) startMusicaArabe();
    }

    // ==================== RENDERIZADO MEJORADO ====================
    function dibujarFondo() {
      ctx.save();
      ctx.scale(canvas.width / (800 * dpr), canvas.height / (600 * dpr));
      
      // Fondo con gradiente m√°s rico
      const grad = ctx.createLinearGradient(0, 0, 0, 600);
      grad.addColorStop(0, '#0f0c29');
      grad.addColorStop(0.3, '#1a1a2e');
      grad.addColorStop(0.6, '#162447');
      grad.addColorStop(1, '#0f3460');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, 800, 600);
      
      // Estrellas con parallax
      ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
      for (let i = 0; i < 50; i++) {
        const x = (i * 73 + juego.tiempo * 0.02) % 800;
        const y = (i * 41) % 200;
        const size = 0.5 + (i % 3) * 0.5;
        const twinkle = 0.5 + Math.sin(juego.tiempo * 0.1 + i) * 0.5;
        ctx.globalAlpha = twinkle;
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.globalAlpha = 1;
      
      // Monta√±as con parallax mejorado
      ctx.fillStyle = '#2d3142';
      dibujarMontanas(0.3, 0, 250, 200, 200, 350, 200, 400, 300, 600, 200, 800, 300);
      ctx.fillStyle = '#1e2736';
      dibujarMontanas(0.6, 0, 300, 150, 250, 350, 150, 550, 250, 750, 300, 800, 400);
      ctx.fillStyle = '#141e2b';
      dibujarMontanas(0.9, 0, 400, 100, 300, 400, 100, 600, 300, 800, 400, 800, 600);
      
      // Nubes animadas con glow
      for (let i = 0; i < 5; i++) {
        const x = (juego.tiempo * 0.15 + i * 200) % 1000 - 100;
        const y = 80 + Math.sin(juego.tiempo * 0.03 + i) * 15;
        
        ctx.shadowColor = 'rgba(255, 255, 255, 0.3)';
        ctx.shadowBlur = 20;
        ctx.fillStyle = 'rgba(255, 255, 255, 0.12)';
        ctx.beginPath();
        ctx.arc(x, y, 35, 0, Math.PI * 2);
        ctx.arc(x + 30, y - 10, 28, 0, Math.PI * 2);
        ctx.arc(x + 55, y, 32, 0, Math.PI * 2);
        ctx.fill();
        ctx.shadowBlur = 0;
      }
      
      // L√≠neas de carril con glow
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.08)';
      ctx.lineWidth = 4;
      for (let i = 0; i < 4; i++) {
        ctx.beginPath();
        ctx.moveTo(i * 200, 0);
        ctx.lineTo(i * 200, 600);
        ctx.stroke();
      }
      
      // L√≠nea central con glow
      ctx.shadowColor = 'rgba(255, 209, 102, 0.5)';
      ctx.shadowBlur = 10;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
      ctx.setLineDash([25, 15]);
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(400, 0);
      ctx.lineTo(400, 600);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.shadowBlur = 0;
      
      // Marcas de velocidad con glow din√°mico
      const glowIntensity = 0.3 + (juego.velocidad - 4.8) * 0.1;
      ctx.shadowColor = `rgba(255, 209, 102, ${glowIntensity})`;
      ctx.shadowBlur = 15;
      ctx.strokeStyle = `rgba(255, 209, 102, ${0.3 + glowIntensity})`;
      ctx.lineWidth = 3;
      for (let i = 0; i < 20; i++) {
        const y = (juego.tiempo * juego.velocidad * 0.3 + i * 35) % 600;
        ctx.beginPath();
        ctx.moveTo(335, y);
        ctx.lineTo(465, y);
        ctx.stroke();
      }
      ctx.shadowBlur = 0;
      
      ctx.restore();
    }

    function dibujarMontanas(factor, ...puntos) {
      ctx.beginPath();
      ctx.moveTo(puntos[0], puntos[1]);
      for (let i = 2; i < puntos.length; i += 2) {
        ctx.lineTo(puntos[i], puntos[i+1]);
      }
      ctx.lineTo(800, 600);
      ctx.lineTo(0, 600);
      ctx.fill();
      
      ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
      ctx.beginPath();
      ctx.moveTo(puntos[0], puntos[1]);
      for (let i = 2; i < puntos.length; i += 2) {
        ctx.lineTo(puntos[i], puntos[i+1] + 15);
      }
      ctx.lineTo(800, 600);
      ctx.lineTo(0, 600);
      ctx.fill();
    }

function dibujarJugador() {
  if (jugador.enEscenaFinal) {
    dibujarEscenaFinal();
    return;
  }

  ctx.save();
  ctx.scale(canvas.width / (800 * dpr), canvas.height / (600 * dpr));

  const cx = POS_X_CARRIL_VIRTUAL[jugador.carril];
  const cy = jugador.yVirtual;
  const inv = jugador.invulnerable && Math.floor(Date.now() / 80) % 2 === 0;
  if (inv) ctx.globalAlpha = 0.4;

  // Aura dorada Paki Ricoh
  if (jugador.pakiRicoh.activo) {
    const aura = ctx.createRadialGradient(cx, cy - 35, 5, cx, cy - 35, 65);
    aura.addColorStop(0, 'rgba(255,215,0,0.35)');
    aura.addColorStop(1, 'rgba(255,215,0,0)');
    ctx.fillStyle = aura;
    ctx.beginPath();
    ctx.arc(cx, cy - 35, 65, 0, Math.PI * 2);
    ctx.fill();
    ctx.shadowColor = '#ffd700';
    ctx.shadowBlur = 30;
  }

  const t = juego.tiempo;
  const enSuelo = jugador.enSuelo;
  const agachado = jugador.agachado;
  const saltando = jugador.saltando;

  // Animaci√≥n de piernas (solo si est√° en suelo y no agachado)
  const swingA = enSuelo && !agachado ? Math.sin(t * 0.22) * 14 : 0;
  const swingB = -swingA;
  const swingBrazos = enSuelo && !agachado ? Math.sin(t * 0.22) * 12 : 0;

  // --- SOMBRA ---
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'rgba(0,0,0,0.25)';
  ctx.beginPath();
  ctx.ellipse(cx, cy + 36, 18, 5, 0, 0, Math.PI * 2);
  ctx.fill();

  // --- ZAPATOS ---
  const shoeColor = '#1a1a1a';
  const shoeHighlight = '#444';
  if (agachado) {
    // Zapatos pegados al cuerpo
    dibujarZapato(ctx, cx - 10, cy + 14, shoeColor, shoeHighlight, 0);
    dibujarZapato(ctx, cx + 2, cy + 14, shoeColor, shoeHighlight, 0);
  } else {
    dibujarZapato(ctx, cx - 12 + swingA * 0.4, cy + 28 + Math.abs(swingA) * 0.15, shoeColor, shoeHighlight, swingA);
    dibujarZapato(ctx, cx + 2 + swingB * 0.4, cy + 28 + Math.abs(swingB) * 0.15, shoeColor, shoeHighlight, swingB);
  }

  // --- PIERNAS (pantal√≥n oscuro) ---
  ctx.fillStyle = '#1a237e';
  if (agachado) {
    // Piernas dobladas
    ctx.beginPath();
    ctx.ellipse(cx - 7, cy + 8, 7, 10, -0.4, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(cx + 7, cy + 8, 7, 10, 0.4, 0, Math.PI * 2);
    ctx.fill();
  } else if (saltando) {
    // Piernas recogidas
    ctx.beginPath();
    ctx.ellipse(cx - 8, cy + 5, 6, 12, -0.5, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.ellipse(cx + 8, cy + 5, 6, 12, 0.5, 0, Math.PI * 2);
    ctx.fill();
  } else {
    // Piernas con swing
    ctx.beginPath();
    ctx.roundRect(cx - 15 + swingA * 0.3, cy - 5, 11, 32, 4);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(cx + 4 + swingB * 0.3, cy - 5, 11, 32, 4);
    ctx.fill();
    // Highlight piernas
    ctx.fillStyle = 'rgba(255,255,255,0.08)';
    ctx.beginPath();
    ctx.roundRect(cx - 14 + swingA * 0.3, cy - 4, 4, 20, 2);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(cx + 5 + swingB * 0.3, cy - 4, 4, 20, 2);
    ctx.fill();
  }

  // --- CUERPO (thobe blanco √°rabe) ---
  ctx.fillStyle = agachado ? '#e0e0e0' : '#f5f5f5';
  if (agachado) {
    ctx.beginPath();
    ctx.ellipse(cx, cy - 10, 20, 15, 0, 0, Math.PI * 2);
    ctx.fill();
  } else {
    ctx.beginPath();
    ctx.moveTo(cx - 17, cy - 55);
    ctx.lineTo(cx + 17, cy - 55);
    ctx.lineTo(cx + 20, cy + 5);
    ctx.lineTo(cx - 20, cy + 5);
    ctx.closePath();
    ctx.fill();
    // Franja central
    ctx.fillStyle = '#bdbdbd';
    ctx.beginPath();
    ctx.moveTo(cx - 2, cy - 55);
    ctx.lineTo(cx + 2, cy - 55);
    ctx.lineTo(cx + 3, cy + 5);
    ctx.lineTo(cx - 3, cy + 5);
    ctx.closePath();
    ctx.fill();
    // Highlight lateral
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.beginPath();
    ctx.moveTo(cx - 16, cy - 54);
    ctx.lineTo(cx - 10, cy - 54);
    ctx.lineTo(cx - 8, cy);
    ctx.lineTo(cx - 14, cy);
    ctx.closePath();
    ctx.fill();
  }

  // --- BRAZOS ---
  ctx.fillStyle = '#d7b899'; // tono piel
  if (agachado) {
    ctx.beginPath();
    ctx.roundRect(cx - 28, cy - 18, 12, 20, 4);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(cx + 16, cy - 18, 12, 20, 4);
    ctx.fill();
  } else if (saltando) {
    ctx.beginPath();
    ctx.roundRect(cx - 26, cy - 60, 12, 28, 4);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(cx + 14, cy - 60, 12, 28, 4);
    ctx.fill();
  } else {
    ctx.beginPath();
    ctx.roundRect(cx - 26, cy - 50 + swingBrazos, 11, 28, 4);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(cx + 15, cy - 50 - swingBrazos, 11, 28, 4);
    ctx.fill();
  }

  // --- CABEZA ---
  // Sombra cabeza
  ctx.fillStyle = '#4e342e';
  ctx.beginPath();
  ctx.arc(cx, cy - 72, 19, 0, Math.PI * 2);
  ctx.fill();
  // Piel √°rabe c√°lida
  const headGrad = ctx.createRadialGradient(cx - 4, cy - 76, 3, cx, cy - 72, 17);
  headGrad.addColorStop(0, '#c8956c');
  headGrad.addColorStop(1, '#8d5a3c');
  ctx.fillStyle = headGrad;
  ctx.beginPath();
  ctx.arc(cx, cy - 72, 17, 0, Math.PI * 2);
  ctx.fill();

  // Kufiya (pa√±uelo √°rabe) - caracter√≠stica principal
  ctx.fillStyle = '#ffffff';
  ctx.beginPath();
  ctx.arc(cx, cy - 72, 18, Math.PI, 0); // parte superior blanca
  ctx.fill();
  // Patr√≥n del kufiya
  ctx.strokeStyle = '#e0e0e0';
  ctx.lineWidth = 1.5;
  for (let i = 0; i < 4; i++) {
    ctx.beginPath();
    ctx.moveTo(cx - 16 + i * 8, cy - 90);
    ctx.lineTo(cx - 20 + i * 8, cy - 72);
    ctx.stroke();
  }
  // Agal (aro negro sobre kufiya)
  ctx.strokeStyle = '#1a1a1a';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.arc(cx, cy - 72, 18, Math.PI + 0.1, -0.1);
  ctx.stroke();
  // Ca√≠da lateral del kufiya
  ctx.fillStyle = 'rgba(255,255,255,0.9)';
  ctx.beginPath();
  ctx.moveTo(cx + 12, cy - 72);
  ctx.lineTo(cx + 20, cy - 55);
  ctx.lineTo(cx + 14, cy - 52);
  ctx.lineTo(cx + 8, cy - 68);
  ctx.closePath();
  ctx.fill();

  // Ojos
  if (jugador.pakiRicoh.activo) {
    // Gafas de sol doradas
    ctx.fillStyle = '#111';
    ctx.beginPath();
    ctx.roundRect(cx - 13, cy - 78, 11, 8, 3);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(cx + 2, cy - 78, 11, 8, 3);
    ctx.fill();
    ctx.strokeStyle = '#ffd700';
    ctx.lineWidth = 2;
    ctx.strokeRect(cx - 14, cy - 79, 13, 10);
    ctx.strokeRect(cx + 1, cy - 79, 13, 10);
    ctx.beginPath();
    ctx.moveTo(cx - 1, cy - 74);
    ctx.lineTo(cx + 1, cy - 74);
    ctx.stroke();
  } else {
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(cx - 7, cy - 76, 4, 0, Math.PI * 2);
    ctx.arc(cx + 7, cy - 76, 4, 0, Math.PI * 2);
    ctx.fill();
    const eyeX = Math.sin(t * 0.05) * 1;
    ctx.fillStyle = '#2d1508';
    ctx.beginPath();
    ctx.arc(cx - 7 + eyeX, cy - 76, 2.2, 0, Math.PI * 2);
    ctx.arc(cx + 7 + eyeX, cy - 76, 2.2, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(cx - 8, cy - 77, 0.8, 0, Math.PI * 2);
    ctx.arc(cx + 6, cy - 77, 0.8, 0, Math.PI * 2);
    ctx.fill();
    // Sonrisa
    ctx.strokeStyle = '#5d3a1a';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(cx, cy - 69, 4, 0.15 * Math.PI, 0.85 * Math.PI);
    ctx.stroke();
    // Bigote fino √°rabe
    ctx.strokeStyle = '#3e2010';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(cx - 3, cy - 71, 3, 0, Math.PI);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(cx + 3, cy - 71, 3, 0, Math.PI);
    ctx.stroke();
  }

  ctx.shadowBlur = 0;
  ctx.globalAlpha = 1;
  ctx.restore();
}

function dibujarZapato(ctx, x, y, color, highlight, swing) {
  ctx.save();
  ctx.translate(x + 8, y);
  ctx.rotate(swing * 0.03);
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.roundRect(-8, -5, 18, 9, [3, 5, 3, 2]);
  ctx.fill();
  ctx.fillStyle = highlight;
  ctx.beginPath();
  ctx.roundRect(-6, -4, 10, 3, 2);
  ctx.fill();
  ctx.restore();
}

    function dibujarEscenaFinal() {
      ctx.save();
      ctx.scale(canvas.width / (800 * dpr), canvas.height / (600 * dpr));
      
      // Mesa con textura
      const mesaGrad = ctx.createLinearGradient(340, 410, 340, 435);
      mesaGrad.addColorStop(0, '#6d4c41');
      mesaGrad.addColorStop(1, '#4e342e');
      ctx.fillStyle = mesaGrad;
      ctx.fillRect(340, 415, 120, 20);
      
      ctx.fillStyle = '#3e2723';
      ctx.fillRect(345, 435, 10, 60);
      ctx.fillRect(445, 435, 10, 60);
      
      ctx.fillStyle = '#d32f2f';
      ctx.fillRect(335, 410, 130, 15);
      ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.fillRect(340, 412, 120, 5);
      
      // Hookah mejorada
      ctx.fillStyle = '#4e342e';
      ctx.fillRect(380, 360, 40, 30);
      ctx.fillStyle = '#2e1b1b';
      ctx.fillRect(385, 330, 8, 30);
      ctx.fillRect(407, 330, 8, 30);
      ctx.fillRect(380, 390, 8, 60);
      ctx.fillRect(412, 390, 8, 60);
      
      const x = 400, y = 380;
      
      // Personaje principal sentado
      ctx.fillStyle = '#4e342e';
      ctx.beginPath();
      ctx.arc(x, y - 45, 18, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = jugador.colorPiel;
      ctx.beginPath();
      ctx.arc(x, y - 45, 16, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = '#2e1b1b';
      ctx.fillRect(x - 8, y - 48, 5, 2);
      ctx.fillRect(x + 3, y - 48, 5, 2);
      
      ctx.strokeStyle = '#2e1b1b';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(x, y - 40, 6, 0.1 * Math.PI, 0.9 * Math.PI);
      ctx.stroke();
      
      // Gafas
      ctx.fillStyle = '#1a1a1a';
      ctx.fillRect(x - 10, y - 47, 20, 6);
      ctx.fillStyle = '#ffd700';
      ctx.fillRect(x - 9, y - 46, 3, 4);
      ctx.fillRect(x + 6, y - 46, 3, 4);
      
      // Cuerpo
      ctx.fillStyle = jugador.colorRopa;
      ctx.beginPath();
      ctx.moveTo(x - 15, y - 30);
      ctx.lineTo(x + 15, y - 30);
      ctx.lineTo(x + 12, y + 5);
      ctx.lineTo(x - 12, y + 5);
      ctx.closePath();
      ctx.fill();
      
      // Manguera
      ctx.fillStyle = jugador.colorPiel;
      ctx.fillRect(x + 15, y - 25, 25, 10);
      ctx.fillStyle = '#8d6e63';
      ctx.fillRect(x + 40, y - 28, 22, 6);
      ctx.fillStyle = '#9e9e9e';
      ctx.fillRect(x + 40, y - 32, 8, 4);
      
      // Brasa
      ctx.shadowColor = '#ff9800';
      ctx.shadowBlur = 15;
      ctx.fillStyle = '#ff9800';
      ctx.beginPath();
      ctx.arc(x + 62, y - 30, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#ffeb3b';
      ctx.beginPath();
      ctx.arc(x + 62, y - 31, 2, 0, Math.PI * 2);
      ctx.fill();
      ctx.shadowBlur = 0;
      
      // Piernas
      ctx.fillStyle = '#1a237e';
      ctx.fillRect(x - 10, y + 5, 12, 28);
      ctx.fillRect(x + 2, y + 12, 12, 22);
      ctx.fillStyle = jugador.colorZapatos;
      ctx.fillRect(x - 12, y + 33, 16, 8);
      ctx.fillRect(x, y + 34, 16, 7);
      
      // Humo √©pico
      for (let i = 0; i < 6; i++) {
        const size = 8 + i * 4;
        const opacity = 0.9 - i * 0.15;
        const yOffset = -50 - i * 22 + Math.sin(juego.tiempo * 0.05 + i) * 5;
        const offsetX = 25 + Math.sin(juego.tiempo * 0.08 + i * 2) * 4;
        
        const smokeGrad = ctx.createRadialGradient(x + offsetX, y + yOffset, 0, x + offsetX, y + yOffset, size);
        smokeGrad.addColorStop(0, `rgba(240, 240, 240, ${opacity})`);
        smokeGrad.addColorStop(1, `rgba(200, 200, 200, 0)`);
        ctx.fillStyle = smokeGrad;
        ctx.beginPath();
        ctx.arc(x + offsetX, y + yOffset, size, 0, Math.PI * 2);
        ctx.fill();
      }
      
      // Amigos
      jugador.amigos.forEach(amigo => {
        ctx.fillStyle = amigo.colorRopa;
        ctx.beginPath();
        ctx.arc(amigo.xVirtual, amigo.yVirtual - 15, 18, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = amigo.colorPiel;
        ctx.beginPath();
        ctx.arc(amigo.xVirtual, amigo.yVirtual - 35, 12, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.fillStyle = '#2e1b1b';
        ctx.fillRect(amigo.xVirtual - 6, amigo.yVirtual - 38, 3, 2);
        ctx.fillRect(amigo.xVirtual + 3, amigo.yVirtual - 38, 3, 2);
        
        ctx.strokeStyle = '#2e1b1b';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(amigo.xVirtual, amigo.yVirtual - 33, 3, 0.1 * Math.PI, 0.9 * Math.PI);
        ctx.stroke();
      });
      
      // Cr√©ditos con glow
      const creditY = 680 - (juego.tiempo % 2000) * 0.65;
      ctx.font = 'bold 30px "Courier New", monospace';
      ctx.textAlign = 'center';
      ctx.shadowColor = '#ffd166';
      ctx.shadowBlur = 20;
      ctx.fillStyle = '#ffd166';
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.9)';
      ctx.lineWidth = 5;
      ctx.strokeText("ESTE ES DEL BUENO", 400, creditY);
      ctx.fillText("ESTE ES DEL BUENO", 400, creditY);
      ctx.strokeText("RESINA PEGAJOSA", 400, creditY + 50);
      ctx.fillText("RESINA PEGAJOSA", 400, creditY + 50);
      ctx.shadowBlur = 0;
      
      ctx.font = 'bold 24px "Courier New", monospace';
      ctx.fillStyle = '#a5d6a7';
      ctx.shadowColor = '#a5d6a7';
      ctx.shadowBlur = 10;
      ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)';
      ctx.lineWidth = 4;
      ctx.strokeText("la paz del segarrero", 400, 90);
      ctx.fillText("la paz del segarrero", 400, 90);
      ctx.shadowBlur = 0;
      
      ctx.restore();
    }

    function dibujarPolicia(obs) {
  ctx.save();
  ctx.scale(canvas.width / (800 * dpr), canvas.height / (600 * dpr));

  const cx = obs.xVirtual + 28;
  const cy = obs.yVirtual;
  const t = juego.tiempo;
  const swing = Math.sin(t * 0.25) * 12;

  // Sombra
  ctx.fillStyle = 'rgba(0,0,0,0.25)';
  ctx.beginPath();
  ctx.ellipse(cx, cy + 28, 22, 6, 0, 0, Math.PI * 2);
  ctx.fill();

  // Zapatos
  dibujarZapatoPolicia(ctx, cx - 10 + swing * 0.4, cy + 26, swing);
  dibujarZapatoPolicia(ctx, cx + 2 - swing * 0.4, cy + 26, -swing);

  // Piernas
  ctx.fillStyle = '#0d47a1';
  ctx.beginPath();
  ctx.roundRect(cx - 14 + swing * 0.3, cy - 2, 11, 28, 3);
  ctx.fill();
  ctx.beginPath();
  ctx.roundRect(cx + 3 - swing * 0.3, cy - 2, 11, 28, 3);
  ctx.fill();

  // Cuerpo
  const bodyGrad = ctx.createLinearGradient(cx - 18, cy - 55, cx + 18, cy);
  bodyGrad.addColorStop(0, obs.colorUniforme);
  bodyGrad.addColorStop(1, obs.colorGorra);
  ctx.fillStyle = bodyGrad;
  ctx.beginPath();
  ctx.roundRect(cx - 18, cy - 58, 36, 60, [4, 4, 6, 6]);
  ctx.fill();
  // Highlight uniforme
  ctx.fillStyle = 'rgba(255,255,255,0.12)';
  ctx.beginPath();
  ctx.roundRect(cx - 16, cy - 56, 12, 40, 3);
  ctx.fill();

  // Cintur√≥n
  ctx.fillStyle = '#1a1a1a';
  ctx.fillRect(cx - 18, cy - 10, 36, 6);
  ctx.fillStyle = '#ffc107';
  ctx.beginPath();
  ctx.arc(cx, cy - 7, 4, 0, Math.PI * 2);
  ctx.fill();

  // Placa
  ctx.fillStyle = '#ffc107';
  ctx.shadowColor = '#ffc107';
  ctx.shadowBlur = 6;
  ctx.beginPath();
  ctx.roundRect(cx + 5, cy - 50, 10, 12, 2);
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.fillStyle = '#1a1a1a';
  ctx.font = 'bold 6px Courier New';
  ctx.textAlign = 'center';
  ctx.fillText('P', cx + 10, cy - 41);

  // Brazos
  ctx.fillStyle = obs.colorUniforme;
  ctx.beginPath();
  ctx.roundRect(cx - 28, cy - 50 - swing * 0.5, 11, 30, 4);
  ctx.fill();
  ctx.beginPath();
  ctx.roundRect(cx + 17, cy - 50 + swing * 0.5, 11, 30, 4);
  ctx.fill();

  // Porra
  ctx.fillStyle = '#4e342e';
  ctx.beginPath();
  ctx.roundRect(cx + 26, cy - 30, 7, 28, 3);
  ctx.fill();
  ctx.fillStyle = '#212121';
  ctx.beginPath();
  ctx.roundRect(cx + 25, cy - 35, 9, 8, 2);
  ctx.fill();

  // Cuello
  ctx.fillStyle = '#f5deb3';
  ctx.beginPath();
  ctx.roundRect(cx - 6, cy - 62, 12, 8, 3);
  ctx.fill();

  // Cabeza
  ctx.fillStyle = '#f5deb3';
  ctx.beginPath();
  ctx.arc(cx, cy - 72, 16, 0, Math.PI * 2);
  ctx.fill();
  // Cara m√°s detallada
  ctx.fillStyle = '#f0d0a0';
  ctx.beginPath();
  ctx.arc(cx, cy - 72, 14, 0, Math.PI * 2);
  ctx.fill();

  // Gorra
  ctx.fillStyle = obs.colorGorra;
  ctx.beginPath();
  ctx.roundRect(cx - 16, cy - 88, 32, 14, [6, 6, 0, 0]);
  ctx.fill();
  // Visera
  ctx.fillStyle = obs.colorGorra;
  ctx.beginPath();
  ctx.ellipse(cx, cy - 74, 20, 5, 0, Math.PI, 0);
  ctx.fill();
  // Banda amarilla gorra
  ctx.fillStyle = '#ffc107';
  ctx.fillRect(cx - 16, cy - 76, 32, 3);

  // Ojos enfadados
  ctx.fillStyle = '#1a1a1a';
  ctx.beginPath();
  ctx.arc(cx - 6, cy - 72, 3, 0, Math.PI * 2);
  ctx.arc(cx + 6, cy - 72, 3, 0, Math.PI * 2);
  ctx.fill();
  // Cejas enfadadas en V
  ctx.strokeStyle = '#333';
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  ctx.moveTo(cx - 10, cy - 77);
  ctx.lineTo(cx - 4, cy - 75);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx + 4, cy - 75);
  ctx.lineTo(cx + 10, cy - 77);
  ctx.stroke();
  // Boca recta
  ctx.strokeStyle = '#8b4513';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx - 5, cy - 64);
  ctx.lineTo(cx + 5, cy - 64);
  ctx.stroke();

  // R√ÅPIDO indicator
  if (obs.velocidadExtra > 0) {
    ctx.fillStyle = '#ff4d4d';
    ctx.shadowColor = '#ff4d4d';
    ctx.shadowBlur = 8;
    ctx.font = 'bold 11px Courier New';
    ctx.textAlign = 'center';
    ctx.fillText('¬°R√ÅPIDO!', cx, cy - 98);
    ctx.shadowBlur = 0;
  }

  ctx.restore();
}

function dibujarZapatoPolicia(ctx, x, y, swing) {
  ctx.save();
  ctx.translate(x + 8, y);
  ctx.rotate(swing * 0.025);
  ctx.fillStyle = '#212121';
  ctx.beginPath();
  ctx.roundRect(-8, -4, 20, 9, [2, 4, 3, 2]);
  ctx.fill();
  ctx.fillStyle = '#444';
  ctx.beginPath();
  ctx.roundRect(-6, -3, 10, 3, 1);
  ctx.fill();
  ctx.restore();
}

  function dibujarCerdo(cerdo) {
  ctx.save();
  ctx.scale(canvas.width / (800 * dpr), canvas.height / (600 * dpr));

  const cx = cerdo.xVirtual + 30;
  const cy = cerdo.yVirtual;
  const t = juego.tiempo;
  const bobY = Math.sin(t * 0.18) * 3;

  // Sombra
  ctx.fillStyle = 'rgba(0,0,0,0.2)';
  ctx.beginPath();
  ctx.ellipse(cx, cy + 16 + bobY, 26, 6, 0, 0, Math.PI * 2);
  ctx.fill();

  // Patas traseras
  ctx.fillStyle = '#e57373';
  ctx.beginPath();
  ctx.roundRect(cx + 12, cy - 5 + bobY, 10, 20, [2, 2, 4, 4]);
  ctx.fill();
  ctx.beginPath();
  ctx.roundRect(cx + 22, cy - 5 + bobY, 10, 20, [2, 2, 4, 4]);
  ctx.fill();
  // Pezu√±as traseras
  ctx.fillStyle = '#b71c1c';
  ctx.beginPath();
  ctx.roundRect(cx + 12, cy + 12 + bobY, 10, 5, [0, 0, 3, 3]);
  ctx.fill();
  ctx.beginPath();
  ctx.roundRect(cx + 22, cy + 12 + bobY, 10, 5, [0, 0, 3, 3]);
  ctx.fill();

  // Cuerpo principal (m√°s natural, menos perfecto)
  const bodyGrad = ctx.createLinearGradient(cx - 28, cy - 20 + bobY, cx + 28, cy + 10 + bobY);
  bodyGrad.addColorStop(0, '#ef9a9a');
  bodyGrad.addColorStop(0.5, '#e57373');
  bodyGrad.addColorStop(1, '#ef9a9a');
  ctx.fillStyle = bodyGrad;
  ctx.beginPath();
  ctx.ellipse(cx - 2, cy - 8 + bobY, 30, 20, 0, 0, Math.PI * 2);
  ctx.fill();

  // Patas delanteras
  ctx.fillStyle = '#e57373';
  ctx.beginPath();
  ctx.roundRect(cx - 32, cy - 5 + bobY, 10, 20, [2, 2, 4, 4]);
  ctx.fill();
  ctx.beginPath();
  ctx.roundRect(cx - 22, cy - 5 + bobY, 10, 20, [2, 2, 4, 4]);
  ctx.fill();
  ctx.fillStyle = '#b71c1c';
  ctx.beginPath();
  ctx.roundRect(cx - 32, cy + 12 + bobY, 10, 5, [0, 0, 3, 3]);
  ctx.fill();
  ctx.beginPath();
  ctx.roundRect(cx - 22, cy + 12 + bobY, 10, 5, [0, 0, 3, 3]);
  ctx.fill();

  // Cabeza
  const headGrad = ctx.createRadialGradient(cx - 22, cy - 32 + bobY, 3, cx - 20, cy - 28 + bobY, 18);
  headGrad.addColorStop(0, '#ffcdd2');
  headGrad.addColorStop(1, '#ef9a9a');
  ctx.fillStyle = headGrad;
  ctx.beginPath();
  ctx.ellipse(cx - 20, cy - 28 + bobY, 18, 16, -0.1, 0, Math.PI * 2);
  ctx.fill();

  // Orejas
  ctx.fillStyle = '#ef9a9a';
  ctx.beginPath();
  ctx.ellipse(cx - 32, cy - 38 + bobY, 8, 10, -0.4, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(cx - 10, cy - 38 + bobY, 7, 9, 0.3, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#f48fb1';
  ctx.beginPath();
  ctx.ellipse(cx - 32, cy - 38 + bobY, 4, 6, -0.4, 0, Math.PI * 2);
  ctx.fill();
  ctx.beginPath();
  ctx.ellipse(cx - 10, cy - 38 + bobY, 3, 5, 0.3, 0, Math.PI * 2);
  ctx.fill();

  // Hocico
  ctx.fillStyle = '#f48fb1';
  ctx.beginPath();
  ctx.ellipse(cx - 20, cy - 23 + bobY, 10, 8, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#ad1457';
  ctx.beginPath();
  ctx.arc(cx - 24, cy - 24 + bobY, 2.5, 0, Math.PI * 2);
  ctx.arc(cx - 16, cy - 24 + bobY, 2.5, 0, Math.PI * 2);
  ctx.fill();

  // Ojos
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(cx - 26, cy - 31 + bobY, 4.5, 0, Math.PI * 2);
  ctx.arc(cx - 14, cy - 31 + bobY, 4.5, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#2d1f1a';
  ctx.beginPath();
  ctx.arc(cx - 26, cy - 31 + bobY, 2.5, 0, Math.PI * 2);
  ctx.arc(cx - 14, cy - 31 + bobY, 2.5, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(cx - 27, cy - 32 + bobY, 1, 0, Math.PI * 2);
  ctx.arc(cx - 15, cy - 32 + bobY, 1, 0, Math.PI * 2);
  ctx.fill();

  // Cola
  ctx.strokeStyle = '#e57373';
  ctx.lineWidth = 3.5;
  ctx.lineCap = 'round';
  ctx.beginPath();
  ctx.moveTo(cx + 26, cy - 12 + bobY);
  ctx.bezierCurveTo(cx + 38, cy - 8 + bobY, cx + 36, cy + 2 + bobY, cx + 28, cy + 4 + bobY);
  ctx.stroke();

  ctx.restore();
}

   function dibujarCigarro(cig) {
  ctx.save();
  ctx.scale(canvas.width / (800 * dpr), canvas.height / (600 * dpr));

  const cx = cig.xVirtual + 22;
  const cy = cig.yVirtual + Math.sin(cig.flotacion) * 4;
  const t = cig.tiempoBrasa;
  const brillo = 0.7 + Math.sin(t * 0.4) * 0.3;

  // Halo de recogida
  const halo = ctx.createRadialGradient(cx, cy - 15, 5, cx, cy - 15, 32);
  halo.addColorStop(0, 'rgba(255,209,102,0.15)');
  halo.addColorStop(1, 'rgba(255,209,102,0)');
  ctx.fillStyle = halo;
  ctx.beginPath();
  ctx.arc(cx, cy - 15, 32, 0, Math.PI * 2);
  ctx.fill();

  // Cigarro (cuerpo principal, inclinado)
  ctx.save();
  ctx.translate(cx, cy - 10);
  ctx.rotate(-0.15);

  // Papel del cigarro
  const cigGrad = ctx.createLinearGradient(-4, -18, 4, -18);
  cigGrad.addColorStop(0, '#f5f5dc');
  cigGrad.addColorStop(0.5, '#fffde7');
  cigGrad.addColorStop(1, '#e8d5a3');
  ctx.fillStyle = cigGrad;
  ctx.beginPath();
  ctx.roundRect(-4, -18, 8, 26, [2, 2, 1, 1]);
  ctx.fill();

  // L√≠neas de papel
  ctx.strokeStyle = 'rgba(200,180,120,0.5)';
  ctx.lineWidth = 0.8;
  for (let i = 0; i < 4; i++) {
    ctx.beginPath();
    ctx.moveTo(-3, -14 + i * 5);
    ctx.lineTo(3, -14 + i * 5);
    ctx.stroke();
  }

  // Filtro (naranja/marr√≥n)
  const filterGrad = ctx.createLinearGradient(-4, 6, 4, 8);
  filterGrad.addColorStop(0, '#d2691e');
  filterGrad.addColorStop(0.5, '#ff8c00');
  filterGrad.addColorStop(1, '#8b4513');
  ctx.fillStyle = filterGrad;
  ctx.beginPath();
  ctx.roundRect(-4, 6, 8, 8, [0, 0, 2, 2]);
  ctx.fill();
  // Textura filtro
  ctx.strokeStyle = 'rgba(0,0,0,0.2)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(-2, 8); ctx.lineTo(2, 8);
  ctx.moveTo(-2, 10); ctx.lineTo(2, 10);
  ctx.moveTo(-2, 12); ctx.lineTo(2, 12);
  ctx.stroke();

  // Brasa con glow animado
  ctx.shadowColor = `rgba(255,120,0,${brillo})`;
  ctx.shadowBlur = 14 * brillo;
  const brasaGrad = ctx.createRadialGradient(0, -20, 0, 0, -20, 6);
  brasaGrad.addColorStop(0, '#ffffff');
  brasaGrad.addColorStop(0.3, '#ffeb3b');
  brasaGrad.addColorStop(0.7, '#ff9800');
  brasaGrad.addColorStop(1, '#e64a19');
  ctx.fillStyle = brasaGrad;
  ctx.beginPath();
  ctx.arc(0, -20, 5 + brillo, 0, Math.PI * 2);
  ctx.fill();
  ctx.shadowBlur = 0;

  // Ceniza
  ctx.fillStyle = '#9e9e9e';
  ctx.beginPath();
  ctx.roundRect(-3, -19, 6, 4, 1);
  ctx.fill();
  ctx.fillStyle = '#bdbdbd';
  ctx.beginPath();
  ctx.roundRect(-2, -19, 4, 2, 1);
  ctx.fill();

  ctx.restore();

  // Humo (3 volutas)
  for (let i = 0; i < 3; i++) {
    const smokeY = cy - 25 - i * 12 + Math.sin(juego.tiempo * 0.06 + i * 2) * 3;
    const smokeX = cx + Math.sin(juego.tiempo * 0.04 + i) * 4;
    const size = 3 + i * 2.5;
    const alpha = (0.5 - i * 0.13) * brillo;
    ctx.fillStyle = `rgba(220,220,220,${alpha})`;
    ctx.beginPath();
    ctx.arc(smokeX, smokeY, size, 0, Math.PI * 2);
    ctx.fill();
  }

  ctx.restore();
}

    function dibujarObstaculos() {
      obstaculos.forEach(obs => dibujarPolicia(obs));
      cerdos.forEach(cerdo => dibujarCerdo(cerdo));
      cigarros.forEach(cig => dibujarCigarro(cig));
    }

    function dibujarParticulas() {
      particulas.forEach(p => p.dibujar(ctx));
    }

    function dibujarTextos() {
      textosEmergentes.forEach(t => t.dibujar(ctx));
    }

    function dibujarEfectoPantallaRoja() {
      if (juego.pantallaRoja > 0) {
        const alpha = juego.pantallaRoja / 40;
        const gradient = ctx.createRadialGradient(
          canvas.clientWidth / 2, canvas.clientHeight / 2, 0,
          canvas.clientWidth / 2, canvas.clientHeight / 2, canvas.clientWidth
        );
        gradient.addColorStop(0, `rgba(255, 50, 50, 0)`);
        gradient.addColorStop(0.5, `rgba(255, 50, 50, ${alpha * 0.3})`);
        gradient.addColorStop(1, `rgba(255, 50, 50, ${alpha})`);
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.clientWidth, canvas.clientHeight);
      }
    }

    function actualizarIndicadorCarril() {
      if (jugador.enEscenaFinal) return;
      
      const posicionesX = [
        virtualX(170),
        virtualX(370),
        virtualX(570)
      ];
      carrilIndicator.style.left = `${posicionesX[jugador.carril]}px`;
      
      if (jugador.carrilCambiado) {
        carrilIndicator.classList.add('active');
        setTimeout(() => carrilIndicator.classList.remove('active'), 200);
        jugador.carrilCambiado = false;
      }
    }

    // ==================== BUCLE PRINCIPAL ====================
    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      ctx.save();
      aplicarShake();
      
      if (juego.estado === 'jugando' || juego.estado === 'pausado_truco') {
        actualizarJugador();
        
        if (juego.estado === 'jugando' && !jugador.enEscenaFinal) {
          generarObstaculo();
          moverObstaculos();
          detectarColisiones();
          actualizarDificultad();
        }
        
        actualizarTextos();
        actualizarParticulas();
        actualizarIndicadorCarril();
        
        juego.tiempo++;
      }
      
      if (juego.estado !== 'gameover') {
        dibujarFondo();
        if (!jugador.enEscenaFinal) {
          dibujarObstaculos();
        }
        dibujarJugador();
        dibujarParticulas();
        dibujarTextos();
        dibujarEfectoPantallaRoja();
      }
      
      ctx.restore();
      
      requestAnimationFrame(gameLoop);
    }

    // ==================== INICIAR ====================
    startBtn.addEventListener('click', () => {
      titleScreen.style.display = 'none';
      juego.estado = 'jugando';
      initAudio();
    });
    
    restartBtn.addEventListener('click', reiniciarJuego);
    
    gameLoop();
  </script>
</body>
</html>
